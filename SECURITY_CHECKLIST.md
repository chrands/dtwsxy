# 安全检查清单

## ✅ 已修复问题

### 1. 认证与授权
- [x] JWT 认证系统已实现 (`src/lib/auth.ts`)
- [x] 登录/注册 API 已添加 (`src/app/api/auth/`)
- [x] 所有需要认证的 API 已添加权限检查
- [x] 角色权限控制已实现 (USER/DOCTOR/ADMIN)

### 2. CORS 安全
- [x] 移除通配符 `Access-Control-Allow-Origin: *`
- [x] 生产环境使用环境变量配置允许的域名
- [x] Credentials 仅在必要时启用

### 3. 数据一致性
- [x] 订单号生成使用事务避免并发冲突
- [x] 订单支付/取消支持幂等处理
- [x] 用户更新时检查手机号/邮箱唯一性
- [x] 帖子创建时验证作者存在性
- [x] 帖子发布状态与发布时间一致性修复

### 4. 数据精度
- [x] 订单金额使用字符串传输，避免浮点精度问题
- [x] 与 Prisma Decimal 类型匹配

### 5. 软删除
- [x] 用户支持软删除 (INACTIVE 状态)
- [x] 帖子使用 DELETED 状态

### 6. 错误处理
- [x] 业务异常统一使用自定义错误类
- [x] 避免泄露敏感错误信息

## 🔒 生产部署前必须检查

### 环境变量
- [ ] `JWT_SECRET` 已更换为强随机密钥
- [ ] `DATABASE_URL` 指向生产数据库
- [ ] `ALLOWED_ORIGINS` 配置为实际域名
- [ ] `NODE_ENV=production`

### 数据库
- [ ] 已执行数据库迁移
- [ ] 已创建数据库索引
- [ ] 已配置数据库备份

### API 安全
- [ ] 所有 API 都已添加认证检查
- [ ] 敏感操作已添加管理员权限检查
- [ ] API 速率限制已配置（建议添加）

### HTTPS
- [ ] 生产环境已启用 HTTPS
- [ ] SSL 证书已配置
- [ ] HTTP 自动重定向到 HTTPS

### 日志与监控
- [ ] 生产环境日志级别设为 'error' 或 'warn'
- [ ] 已配置日志收集系统
- [ ] 已配置错误监控（如 Sentry）

### 其他
- [ ] 密码策略已加强（长度、复杂度）
- [ ] 已配置 CSRF 保护（建议添加）
- [ ] 已添加 API 速率限制（建议添加）
- [ ] 已进行安全渗透测试

## 🚨 建议添加的功能

### 1. CSRF 保护
考虑添加 CSRF Token 验证机制

### 2. API 速率限制
使用 redis 或 upstash 实现速率限制

### 3. 输入验证增强
- SQL 注入防护（Prisma 已内置）
- XSS 防护（前端需处理）
- 文件上传限制

### 4. 审计日志
记录敏感操作：
- 用户登录/登出
- 权限变更
- 数据删除

### 5. 会话管理
- Token 刷新机制
- Token 黑名单（登出后失效）
- 多设备登录控制

### 6. 数据加密
- 敏感字段加密存储
- 传输加密（HTTPS）

## 📝 安全审计建议

定期进行以下检查：
1. 依赖包安全漏洞扫描 (`npm audit`)
2. 代码安全审查
3. 渗透测试
4. 日志分析